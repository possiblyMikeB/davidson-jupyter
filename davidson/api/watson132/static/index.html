<!DOCTYPE html>
<meta charset='utf-8'>
<html>
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
      td, th {
          padding: 1px 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row" id="table">
      </div>
    </div>
    <script type='text/javascript'>
      function toTitleCase(str) {
          return str.replace(/_/g, ' ').replace(
              /\w\S*/g,
              function(txt) {
                  return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
              }
          );
      }
      d3.json('http://ipa0.rc.davidson.edu/api/status', function (error,data) {
          function tabulate(data, columns) {
		      var table = d3.select('#table').append('table').attr("class", "table table-hover");
		      var thead = table.append('thead');
		      var tbody = table.append('tbody');

		      // append the header row
		      thead.append('tr')
		          .selectAll('th')
		          .data(columns).enter()
		          .append('th')
		          .text(function (column) { return toTitleCase(column); });

              data.sort((a,b) => { return ( a.tag < b.tag ? -1 : 1 ); });
		      // create a row for each object in the data
		      var rows = tbody.selectAll('tr')
		          .data(data)
		          .enter()
		          .append('tr');
              
		      // create a cell in each row for each column
		      var cells = rows.selectAll('td')
		          .data(function (row) {
                      // add derived columns
                      if(row.system == "Linux")
                          row.hostname = `${row.tag}.rc.davidson.edu`;
                      else
                          row.hostname = `${row.tag}.davidson.edu`;

                      date = new Date(row.timestamp);
                      row.last_updated = date.toLocaleDateString(
                          "en-US",
                          {day: "2-digit", month: "2-digit", year: "2-digit",
                           hour: "2-digit", minute: "2-digit", second: "2-digit"}
                      )
                      // restrict to insteresting object members
		              return columns.map(function (column) {
		                  return {column: column, value: row[column]};
		              });
		          })
		          .enter()
		          .append('td')
		          .text(function (d) { return d.value; });
              
	          return table;
	      }

	      // render the table(s)
	      tabulate(data, ['tag', 'system', 'users', 'hostname', 'ip', 'last_updated']); // 2 column table

      });

    </script>
  </body>
</html>
